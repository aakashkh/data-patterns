{{ $needKaTeX  := or .Params.math .Site.Params.katex.enable .Params.chem .Site.Params.chem (.Page.Store.Get "hasKaTeX") (.Page.Store.Get "hasmhchem") -}}
{{ $needmhchem := or .Params.chem .Site.Params.katex.mhchem.enable (.Page.Store.Get "hasmhchem") -}}

{{ if .Site.Params.markmap.enable -}}
<style>
.markmap > svg {
  width: 100%;
  height: 300px;
}
</style>
<script>
window.markmap = {
  autoLoader: {
      manual: true,
      onReady() {
        const { autoLoader, builtInPlugins } = window.markmap;
        autoLoader.transformPlugins = builtInPlugins.filter(plugin => plugin.name !== 'prism');
      },
  },
};
</script>
<script src="https://cdn.jsdelivr.net/npm/markmap-autoloader"></script>
{{ end -}}

{{ if .Site.Params.plantuml.enable -}}
  <script src='{{ "js/deflate.js" | relURL }}'></script>
{{ end -}}

{{ if $needKaTeX -}}
  {{ partial "scripts/katex.html" (dict "mhchem" $needmhchem) -}}
{{ end -}}

{{/* Initialize an empty slice to hold all JS resources */}}
{{ $jsResources := slice }}

{{/* Only include Bootstrap if the file exists */}}
{{ $jsBs := resources.Get "vendor/bootstrap/dist/js/bootstrap.bundle.js" }}
{{ if $jsBs }}
  {{ $jsResources = $jsResources | append $jsBs }}
{{ end }}

{{/* Include base.js if it exists */}}
{{ $jsBase := resources.Get "js/base.js" }}
{{ if $jsBase }}
  {{ $jsResources = $jsResources | append $jsBase }}
{{ end }}

{{/* Handle search.js or offline-search.js */}}
{{ $jsSearch := "" }}
{{ if .Site.Params.offlineSearch }}
  {{ $jsSearch = resources.Get "js/offline-search.js" }}
{{ else }}
  {{ $jsSearch = resources.Get "js/search.js" | resources.ExecuteAsTemplate "js/search.js" .Site.Home }}
{{ end }}
{{ if $jsSearch }}
  {{ $jsResources = $jsResources | append $jsSearch }}
{{ end }}

{{/* Only include markmap.js if markmap is enabled */}}
{{ if .Site.Params.markmap.enable }}
  {{ $jsMarkmap := resources.Get "js/markmap.js" | resources.ExecuteAsTemplate "js/markmap.js" . }}
  {{ if $jsMarkmap }}
    {{ $jsResources = $jsResources | append $jsMarkmap }}
  {{ end }}
{{ end }}

{{/* Only include plantuml.js if plantuml is enabled */}}
{{ if .Site.Params.plantuml.enable }}
  {{ $jsPlantuml := resources.Get "js/plantuml.js" | resources.ExecuteAsTemplate "js/plantuml.js" . }}
  {{ if $jsPlantuml }}
    {{ $jsResources = $jsResources | append $jsPlantuml }}
  {{ end }}
{{ end }}

{{/* Only include drawio.js if drawio is enabled */}}
{{ if .Site.Params.drawio.enable }}
  {{ $jsDrawio := resources.Get "js/drawio.js" | resources.ExecuteAsTemplate "js/drawio.js" . }}
  {{ if $jsDrawio }}
    {{ $jsResources = $jsResources | append $jsDrawio }}
  {{ end }}
{{ end }}

{{/* Include dark mode script if enabled */}}
{{ if .Site.Params.ui.showLightDarkModeMenu }}
  {{ $jsDarkMode := resources.Get "js/dark-mode.js" }}
  {{ if $jsDarkMode }}
    {{ $jsResources = $jsResources | append $jsDarkMode }}
  {{ end }}
{{ end }}

{{/* Only try to concatenate if we have resources */}}
{{ $js := "" }}
{{ if gt (len $jsResources) 0 }}
  {{ $js = $jsResources | resources.Concat "js/main.js" }}
{{ end }}
{{ if hugo.IsProduction -}}
  {{ $js := $js | minify | fingerprint -}}
  <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous"></script>
{{ else -}}
  <script src="{{ $js.RelPermalink }}"></script>
{{ end -}}

{{ if .Site.Params.prism_syntax_highlighting -}}
  <script src='{{ "js/prism.js" | relURL }}'></script>
{{ else if ( not .Site.Params.disable_click2copy_chroma ) -}}
  {{ $c2cJS := resources.Get "js/click-to-copy.js" -}}
  {{ if hugo.IsProduction -}}
    {{ $c2cJS = $c2cJS | minify | fingerprint -}}
  {{ end -}}
  <script defer src="{{ $c2cJS.RelPermalink }}" {{ with $c2cJS.Data.Integrity -}}
    integrity="{{ . }}" {{ end -}}
    crossorigin="anonymous"></script>
{{ end -}}

{{ if and .Site.Params.search (isset .Site.Params.search "algolia") -}}
  {{ template "algolia/scripts" .Site.Params.search.algolia -}}
{{ end -}}
<script src='{{ "js/tabpane-persist.js" | relURL }}'></script>
{{ partial "hooks/body-end.html" . -}}

{{ define "algolia/scripts" -}}
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3.8.2"
  integrity="sha512-lsD+XVzdBI6ZquXc8gqbw0/bgrfIsMJwY/8xvmvbN+U3gZSeG7BXQoCq4zv/yCmntR2GLHtgB+bD4ESPsKIbIA=="
  crossorigin="anonymous" ></script>
<script type="text/javascript">
const containers = ['#docsearch-0', '#docsearch-1'];
for (let c of containers) {
  docsearch({
    container: c,
    appId: {{ .appId | default "R2IYF7ETH7" }},
    apiKey: {{ .apiKey | default "599cec31baffa4868cae4e79f180729b" }},
    indexName: {{ .indexName | default "docsearch" }},
  });
}
</script>
{{ end -}}

<!-- Custom JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Data Patterns site loaded');
});
</script>